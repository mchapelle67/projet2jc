{% extends 'base.html.twig' %}

{% block title %}Demande de rendez-vous{% endblock %}

{% block body %}
{% for label, messages in app.flashes %}
    {% set alertClass = (label == 'error') ? 'danger' : label %}
    {% for message in messages %}
        <div class="alert alert-{{ alertClass }}">
            {{ message }}
        </div>
    {% endfor %}
{% endfor %}

<section="form">
<h1>Demande de rendez-vous</h1>
    <h2>Attention, ceci est une demande de rendez-vous ! Veuillez noter qu'il est nécéssaire d'attendre une confirmation de notre équipe.</h2>

<div class="form-container">
    <div class="progress-bar-container">
        <div class="progress-bar-form">
            <div class="step active" data-step-title="Infos">1</div>
            <div class="progress-line"></div>
            <div class="step" data-step-title="Vehicule">2</div>
            <div class="progress-line"></div>
            <div class="step" data-step-title="Date">3</div>
            <div class="progress-line"></div>
            <div class="step" data-step-title="Recap">4</div>
        </div>
    </div>


{{ form_start(rdvForm, {'attr': {'id': 'client-form'}}) }}
    <div class="form-step active">
        <h2>Informations personnelles</h2>
                {{ form_row(rdvForm.nom, {'row_attr': {'class': 'form-group'}}) }}
                {{ form_row(rdvForm.prenom, {'row_attr': {'class': 'form-group'}}) }}
                {{ form_row(rdvForm.email, {'row_attr': {'class': 'form-group'}}) }}
                {{ form_row(rdvForm.tel, {'row_attr': {'class': 'form-group'}}) }}
                <h3 class="champs-obligatoires">*champs obligatoires</h3>
    </div>
    <div class="form-step">
        <h2>Informations du véhicule</h2>
            <div class="form-group">
                <label for="marques-list">Veuillez séléctionner une marque*</label>
                <input list="marques-list" id="marque" name="marque" class="form-control" autocomplete="off">
                <datalist id="marques-list">
                    {% for marque in marques %}
                    <option value="{{ marque.Make_Name }}"></option>
                    {% endfor %}
                </datalist>
                {{ form_row(rdvForm.vehicule.marque) }}
            </div>
            <div class="form-group">
                <label for="modeles-list">Veuillez séléctionner un modèle*</label>
                <input list="modeles-list" id="modele" name="modele" class="form-control" autocomplete="off">
                <datalist id="modeles-list"></datalist>
                {{ form_row(rdvForm.vehicule.modele) }}
            </div>
                {{ form_row(rdvForm.vehicule.anneeFabrication, {'row_attr': {'class': 'form-group'}}) }}
                {{ form_row(rdvForm.vehicule.km, {'row_attr': {'class': 'form-group'}}) }}
                {{ form_row(rdvForm.vehicule.carburant, {'row_attr': {'class': 'form-group'}}) }}
    </div>
    <div class="form-step">
        <h2>Choisissez un créneau</h2>
            {{ form_row(rdvForm.prestation, {'row_attr': {'class': 'form-group'}}) }}
            {{ form_row(rdvForm.date_rdv, {'row_attr': {'class': 'form-group'}}) }}
        </div>
    <div class="form-step">
        <h2>Recapitulatif de votre demande</h2>
            <div id="reviewDetails">
                <p>Nom et prenom: <span data-review="nom"></span> <span data-review="prenom"></span></p>
                <p>Email: <span data-review="email"></span></p>
                <p>Numéro de téléphone: <span data-review="tel"></span></p>
                <p>Marque: <span data-review="marque"></span></p>
                <p>Modèle: <span data-review="modele"></span></p>
                <p>Année de fabrication: <span data-review="anneeFabrication"></span></p>
                <p>Nombre de kilomètre: <span data-review="km"></span></p>
                <p>Carburant: <span data-review="carburant"></span></p>
                <p>Prestation: <span data-review="prestation"></span></p>
                <p>Rendez-vous: <span data-review="dateRdv"></span></p>
        </div>
    </div>
    <!-- Navigation -->
    <div class="form-navigation">
        <button type="button" id="prevBtn" class="btn btn-secondary">Précédent</button>
        <button type="button" id="nextBtn" class="btn btn-primary">Suivant</button>
        <button type="submit" id="submitBtn" class="btn btn-primary" style="display: none;">Valider</button>
    </div>
</div>
{{ form_end(rdvForm) }}
</section>
{% endblock %}

{% block javascripts %}
<script>
// on charge les marques au chargement de la page
document.addEventListener('DOMContentLoaded', function() {

    // on récupère les marques depuis l'API
    document.getElementById('marque').addEventListener('change', function() {
        const marque = this.value;
        console.log('Marque sélectionnée :', marque);

        // mettre à jour le champ caché pour la marque
        const marqueHidden = document.querySelector('[name="rdv_type_form[vehicule][marque]"]');
        if (marqueHidden) {
            marqueHidden.value = marque;
            console.log('Champ caché marque mis à jour :', marqueHidden.value);
        } else {
            console.log('Champ caché marque introuvable');
        }

        // appel à l'API pour récupérer les modèles associés à la marque
        fetch('/api/modeles?marque=' + encodeURIComponent(marque))
            .then(response => response.json())
            .then(data => {
                console.log('Modèles reçus :', data);
                const datalist = document.getElementById('modeles-list');
                datalist.innerHTML = '';
                if (data.length === 0) {
                    datalist.innerHTML = `<option value="Pas de modèle associé"></option>`;
                } else {
                    data.forEach(modele => {
                        datalist.innerHTML += `<option value="${modele.Model_Name}"></option>`;
                    });
                }
            });
    });

    // on met à jour le champ caché pour le modèle sélectionné
    document.getElementById('modele').addEventListener('change', function() {
        const modele = this.value;
        console.log('Modèle sélectionné :', modele);

        const modeleHidden = document.querySelector('[name="rdv_type_form[vehicule][modele]"]');
        if (modeleHidden) {
            modeleHidden.value = modele;
            console.log('Champ caché modèle mis à jour :', modeleHidden.value);
        } else {
            console.log('Champ caché modèle introuvable');
        }
    });

// création les animations du formulaire
    const formSteps = Array.from(document.querySelectorAll('.form-step'));
    const progressSteps = Array.from(document.querySelectorAll('.progress-bar-form .step'));
    const progressLines = Array.from(document.querySelectorAll('.progress-bar-form .progress-line'));
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('client-form');
    
    let currentStep = 0;
    
    // initialise les étapes du formulaire en ajoutant active si l'index correspond à l'étape actuelle
    function updateFormSteps() {
        formSteps.forEach((step, index) => {
            step.classList.toggle('active', index === currentStep);
        });
    }
    
    // met à jour la barre de progression en ajoutant active ou completed selon l'étape actuelle
    function updateProgressBar() {
        progressSteps.forEach((step, index) => {
            if (index < currentStep) {
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (index === currentStep) {
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                step.classList.remove('active', 'completed');
            }
        });
        
        progressLines.forEach((line, index) => {
            line.classList.toggle('active', index < currentStep);
        });
    }
    
    // met à jour les boutons de navigation en fonction de l'étape actuelle
    function updateNavigationButtons() {
        prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-block';
        // Affiche le bouton "Suivant" sauf à la dernière étape
        nextBtn.style.display = currentStep < formSteps.length - 1 ? 'inline-block' : 'none';
        // Affiche le bouton "Valider" seulement à la dernière étape
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.style.display = currentStep === formSteps.length - 1 ? 'inline-block' : 'none';
        }
    }
    
    // validation de l'étape actuelle
    function validateStep(stepIndex) {
        const currentFormStep = formSteps[stepIndex];
        const inputs = Array.from(currentFormStep.querySelectorAll('input[required], select[required]'));
        let isValid = true;
        
        // gestion des erreurs
        currentFormStep.querySelectorAll('.error-message').forEach(el => el.remove());
        inputs.forEach(input => input.classList.remove('invalid'));
        
        inputs.forEach(input => {
            let fieldValid = true;
            if (input.type === 'checkbox' && !input.checked) {
                fieldValid = false;
            } else if (input.value.trim() === '') {
                fieldValid = false;
            } else if (input.type === 'email' && !/^\S+@\S+\.\S+$/.test(input.value)) {
                fieldValid = false;
            }
            
            if (!fieldValid) {
                isValid = false;
                input.classList.add('invalid');
                const errorMsg = document.createElement('p');
                errorMsg.className = 'error-message';
                errorMsg.textContent = input.type === 'checkbox' ? 'Ce champs est requis.' : 'Veuillez saisir une donnée valide';
                input.parentNode.appendChild(errorMsg);
            }
        });

      // vérification spécifique pour l'étape 2 : marque et modèle obligatoires
        if (stepIndex === 1) {
            const marque = document.getElementById('marque');
            const modele = document.getElementById('modele');
            if (!marque.value.trim() || !modele.value.trim()) {
                isValid = false;
                [marque, modele].forEach(input => {
                    if (input && !input.value.trim()) {
                        input.classList.add('invalid');
                        const errorMsg = document.createElement('p');
                        errorMsg.className = 'error-message';
                        errorMsg.textContent = 'Ce champ est requis.';
                        input.parentNode.appendChild(errorMsg);
                    }
                });
            }
        }
        return isValid;
    }    
    
    // gerer le recapitulatif 
    function populateReviewDetails() {
        const formData = new FormData(form);
        const reviewData = {
            nom: formData.get('rdv_type_form[nom]') || 'Non renseigné',
            prenom: formData.get('rdv_type_form[prenom]') || 'Non renseigné',
            email: formData.get('rdv_type_form[email]') || 'Non renseigné',
            tel: formData.get('rdv_type_form[tel]') || 'Non renseigné',
            marque: formData.get('marque') || 'Non renseigné',
            modele: formData.get('modele') || 'Non renseigné',
            anneeFabrication: formData.get('rdv_type_form[vehicule][anneeFabrication]') || 'Non renseigné',
            km: formData.get('rdv_type_form[vehicule][km]') || 'Non renseigné',
            carburant: (() => {
                const select = document.getElementById('rdv_type_form_vehicule_carburant');
                if (select) {
                    const selected = select.options[select.selectedIndex];
                    return selected ? selected.textContent : 'Non renseigné';
                }
                return 'Non renseigné';
            })(),
            prestation: (() => {
                    const select = document.getElementById('rdv_type_form_prestation');
                    if (select) {
                        const selected = select.options[select.selectedIndex];
                        return selected ? selected.textContent : 'Non renseigné';
                    }
                    return 'Non renseigné';
                })(),       
            dateRdv: (() => {
                const raw = formData.get('rdv_type_form[date_rdv]');
                if (!raw) return 'Non renseigné';
                const date = new Date(raw);
                if (isNaN(date)) return raw; // si la conversion échoue, affiche brut

                // Format : JJ/MM/AAAA à HH:MM
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} à ${hours}:${minutes}`;
            })(),        
        };
        
        for (const key in reviewData) {
            const element = document.querySelector(`#reviewDetails [data-review="${key}"]`);
            if (element) {
                element.textContent = reviewData[key];
            }
        }
    }
    
    // permet de passer à l'étape suivante si la validation est réussie
    nextBtn.addEventListener('click', () => {
        if (validateStep(currentStep)) {
            currentStep++;
            if (currentStep === formSteps.length - 1) { 
                populateReviewDetails();
            }
            updateFormSteps();
            updateProgressBar();
            updateNavigationButtons();
        }
    });
    
    // permet de revenir à l'étape précédente
    prevBtn.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            updateFormSteps();
            updateProgressBar();
            updateNavigationButtons();
        }
    });
    
    // inititalise 
    updateFormSteps();
    updateProgressBar();
    updateNavigationButtons();
});
</script>
{% endblock %}
